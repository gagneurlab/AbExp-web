<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>AbSplice output</title>
    <link rel="icon" href="static/icon.png" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="..." crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
	<script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.2/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css">
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/fixedheader/3.2.3/js/dataTables.fixedHeader.min.js"></script>
	<style type="text/css" class="init">
	
        thead input {
            width: 100%;
        }

	</style>
	<script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/fixedheader/3.2.3/js/dataTables.fixedHeader.min.js"></script>
	<script type="text/javascript" class="init">

        $(document).ready(function () {
            $('#result-table thead tr')
                .clone(true)
                .addClass('filters')
                .appendTo('#result-table thead');

            var table = $('#result-table').DataTable({
                "autoWidth": false,
                orderCellsTop: true,
                order: [],
                fixedHeader: true,
                paging: false,
                // "pageLength": 50,
                initComplete: function () {
                    var api = this.api();

                    api
                        .columns()
                        .eq(0)
                        .each(function (colIdx) {
                            var cell = $('.filters th').eq(
                                $(api.column(colIdx).header()).index()
                            );
                            var title = $(cell).text();
                            $(cell).html('<input type="text" placeholder="' + title + '" />');

                            $(
                                'input',
                                $('.filters th').eq($(api.column(colIdx).header()).index())
                            )
                                .off('keyup change')
                                .on('change', function (e) {
                                    $(this).attr('title', $(this).val());
                                    var regexr = '({search})';

                                    var cursorPosition = this.selectionStart;

                                    api
                                        .column(colIdx)
                                        .search(
                                            this.value != ''
                                                ? regexr.replace('{search}', '(((' + this.value + ')))')
                                                : '',
                                            this.value != '',
                                            this.value == ''
                                        )
                                        .draw();
                                })
                                .on('keyup', function (e) {
                                    e.stopPropagation();

                                    $(this).trigger('change');
                                    $(this)
                                        .focus()[0]
                                        .setSelectionRange(cursorPosition, cursorPosition);
                                });
                        });
                },
            });
        });

	</script>
    <script>
        function showInfo(column) {
            var infoContent = document.getElementById('info-content-' + column);
            infoContent.style.display = 'block';
            document.getElementById('main_container').classList.add('blur-background');
        }

        function hideInfo(column) {
            var infoContent = document.getElementById('info-content-' + column);
            infoContent.style.display = 'none';
            document.getElementById('main_container').classList.remove('blur-background');
        }
    </script>
    <style>
        .blue-button {
            background-color: #7393B3;
            color: white;
        }
        .light-red {
            background-color: #FFC3B7;
        }
    
        .light-orange {
            background-color: #FFEBC9;
        }
    
        .light-yellow {
            background-color: lightyellow;
        }
    
        .light-green {
            background-color: #D7FFC7;
        }

        .blur-background {
            filter: blur(3px);
        }

        body {
            font-size: 15px;
        }
        table {
            border-collapse: collapse;
            table-layout: auto;
            width: 100%;
            background-color: #dee6ff;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background-color: #f2f2f2;
        }

        .info-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background-color: #f2f2f2;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

    </style>
</head>
<body>
        <div id="info-content-AbSplice" class="info-content" style="display: none;">
            <p>The AbSplice score is a probability estimate of how likely aberrant splicing of some sort takes place in a given tissue and reports the splice site with the strongest effect. To ease downstream applications we suggest three cutoffs (high: 0.2, medium: 0.05, low: 0.01), which approximately have the same recalls as the high, medium and low cutoffs of SpliceAI.</p>
        </div>
        <div id="info-content-delta_score" class="info-content" style="display: none;">
            <p>Input feature to AbSplice. The main score predicted by SpliceAI, computed as a maximum of acceptor gain, acceptor loss, donor gain, and donor loss delta scores. The score represents probability of the variant being splice-altering.</p>
        </div>
        <div id="info-content-Tissue" class="info-content" style="display: none;">
            <p>Name of the tissue that was used from SpliceMap.</p>
        </div>
        <div id="info-content-Splice_site_is_expressed" class="info-content" style="display: none;">
            <p>Input feature to AbSplice. Binary feature indicating if the splice site is expressed in the target tissue using a cutoff of 10 split reads (<code>median_n</code> from SpliceMap).</p>
        </div>
        <div id="info-content-delta_logit_psi" class="info-content" style="display: none;">
            <p>Input feature to AbSplice. The score is computed by using SpliceMap as an annotation for MMSplice. The score shows the effect of the variant on the inclusion level (PSI - percent spliced in) of the junction. The score is on a logit scale. If the score is positive, it shows that variant leads higher inclusion rate for the junction. If the score is negative, it shows that variant leads higher exclusion rate for the junction.</p>
        </div>
        <div id="info-content-delta_psi" class="info-content" style="display: none;">
            <p>Input feature to AbSplice. The delta_psi (∆Ψ) score is computed by converting delta_logit_psi (∆𝑙𝑜𝑔𝑖𝑡(Ψ)) to natural scale with the splicing scaling law and ref_psi (Ψ𝑟𝑒𝑓):</p>
            <p>∆Ψ = σ(∆𝑙𝑜𝑔𝑖𝑡(Ψ) + 𝑙𝑜𝑔𝑖𝑡(Ψ𝑟𝑒𝑓)) − Ψ𝑟𝑒𝑓</p>
        </div>
        <div id="info-content-Junction" class="info-content" style="display: none;">
            <p>Coordinates of the respective intron from SpliceMap.</p>
        </div>
        <div id="info-content-Splice_site" class="info-content" style="display: none;">
            <p>Coordinates of the splice site.</p>
        </div>
        <div id="info-content-ref_psi" class="info-content" style="display: none;">
            <p>Reference level of site usage from SpliceMap.</p>
        </div>
    <div class="container-fluid" id="main_container">
        <div class="container-fluid">
            <h1 class="text-center mt-5 mb-5">AbSplice output</h1>
            <p>On this page you can see the AbSplice output for your variant(s). Use filter options to display results for only those tissues, genes or variants that you want to view. Use filter for AbSplice score column to show only those scores that are higher than the chosen cutoff.</p>
            <p>The output table contains the following columns with hyperlinks:
                <ul>
                    <li>Variant: Link to the UCSC browser</li>
                    <li>Gene ID: Link to Ensembl gene description</li>
                </ul>
            </p>
            <div style="display: flex; justify-content: space-between;">
                <button class="btn btn-primary mb-3 " style="background-color: #CCE8FF;"><a href="{{ url_for('index') }}">Back to the input page</a></button>
                <button class="btn btn-primary mb-3 " style="background-color: #CCE8FF;"><a href="data:text/csv;charset=utf-8,{{ csv_output | urlencode }}" download="AbSplice_ouput.csv">Download the output as CSV</a></button>
            </div>
            <table id="result-table" class="table">
                <thead>
                    <tr>
                        <th class="align-top">Variant
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column1-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column1-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column1', '')">All</a>
                                    {% for value in unique_column1_values %}
                                        <a class="dropdown-item" href="#" onclick="filterColumn('column1', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th>
                        <th class="align-top">Gene ID
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column2-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column2-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column2', '')">All</a>
                                    {% for value in unique_column2_values %}
                                        <a class="dropdown-item" href="#" onclick="filterColumn('column2', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th>
                        <th class="align-top">Gene name
                        </th>
                        <th class="align-top">Tissue <i class="fas fa-info-circle" onmouseover="showInfo('Tissue')" onmouseout="hideInfo('Tissue')"></i>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column3-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column3-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column3', '')">All</a>
                                    {% for value in unique_column4_values %}
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column3', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th>
                        <th class="align-top">AbSplice score <i class="fas fa-info-circle" onmouseover="showInfo('AbSplice')" onmouseout="hideInfo('AbSplice')"></i>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column4-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Cutoff
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column4-dropdown">
                                    <a class="dropdown-item" href="#" onclick="filterAbSpliceDNA('all')">All</a>
                                    <a class="dropdown-item" href="#" onclick="filterAbSpliceDNA('high')">High (> 0.2)</a>
                                    <a class="dropdown-item" href="#" onclick="filterAbSpliceDNA('medium')">Medium (> 0.05)</a>
                                    <a class="dropdown-item" href="#" onclick="filterAbSpliceDNA('low')">Low (> 0.01)</a>
                                </div>
                            </div>
                        </th>                
                        <th class="align-top">Delta PSI <i class="fas fa-info-circle" onmouseover="showInfo('delta_psi')" onmouseout="hideInfo('delta_psi')"></i>
                        </th>
                        <th class="align-top">Delta score <i class="fas fa-info-circle" onmouseover="showInfo('delta_score')" onmouseout="hideInfo('delta_score')"></i>
                        </th>
                        <th class="align-top">Junction <i class="fas fa-info-circle" onmouseover="showInfo('Junction')" onmouseout="hideInfo('Junction')"></i>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column_junction-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column3-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_junction', '')">All</a>
                                    {% for value in unique_junction_values %}
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_junction', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th>
                        <th class="align-top">Reference PSI <i class="fas fa-info-circle" onmouseover="showInfo('ref_psi')" onmouseout="hideInfo('ref_psi')"></i>
                        </th>
                        <th class="align-top">Splice site is expressed <i class="fas fa-info-circle" onmouseover="showInfo('Splice_site_is_expressed')" onmouseout="hideInfo('Splice_site_is_expressed')"></i>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column_splice_site_is_expressed-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column_splice_site_is_expressed-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_splice_site_is_expressed', '')">All</a>
                                    {% for value in unique_yes_no_values %}
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_splice_site_is_expressed', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th>
                        <th class="align-top">Splice site <i class="fas fa-info-circle" onmouseover="showInfo('Splice_site')" onmouseout="hideInfo('Splice_site')"></i>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm align-bottom" type="button" id="column_splice_site-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column_splice_site-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_splice_site', '')">All</a>
                                    {% for value in unique_splice_site_values %}
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_splice_site', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th>
                        <!-- <th class="align-top">Event type <i class="fas fa-info-circle" onmouseover="showInfo('Event_type')" onmouseout="hideInfo('Event_type')"></i>
                            <div class="dropdown">
                                <button class="btn btn-secondary dropdown-toggle blue-button btn-sm" type="button" id="column_event_type-dropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    Filter
                                </button>
                                <div class="dropdown-menu" aria-labelledby="column_event_type-dropdown" style="overflow-y: auto; max-height: 300px">
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_event_type', '')">All</a>
                                    {% for value in unique_event_type_values %}
                                    <a class="dropdown-item" href="#" onclick="filterColumn('column_event_type', '{{ value }}')">{{ value }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </th> -->
                    </tr>
                </thead>
                <tbody>
                    {% for row in output %}
                    <tr data-column1="{{ row[0] }}" data-column2="{{ row[1] }}" data-column4="{{ row[3] }}">
                        <td data-column="column1"><a href="#" onclick="generateLink('{{ row[0] }}', '{{ genome }}')">{{ row[0] }}</a></td>
                        <td data-column="column2"><a href="https://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g={{ row[1] }}" target="_blank">{{ row[1] }}</a></td>
                        <td data-column="column_gene_name">
                            {{ row[11]|join(', ') }}
                        </td>
                        <td data-column="column3">{{ row[3] }}</td>
                        <td data-column="column4" class="{% if row[2]|float > 0.2 %}light-red{% elif row[2]|float > 0.05 %}light-orange{% elif row[2]|float > 0.01 %}light-yellow{% else %}light-green{% endif %}">{{ row[2] | float }}</td>
                        <td data-column="column5">{{ row[6] | float }}</td>
                        <td data-column="column6">{{ row[7] | float }}</td>
                        <td data-column="column_junction">{{ row[4] }}</td>
                        <td data-column="column_ref_psi">{{ row[5] | float }}</td>
                        <td data-column="column_splice_site_is_expressed">{{ row[8] }}</td>
                        <td data-column="column_splice_site">{{ row[9] }}</td>
                        <!-- <td data-column="column_event_type">{{ row[10] }}</td> -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button class="btn btn-primary mb-3 " style="background-color: #3c97ff;" onclick="resetFilters()">Reset Filters</button>
        </div> 

        <script>
            var filterStates = {
                column1: '',
                column2: '',
                column3: '',
                column4: '',
                column5: '',
                column6: '',
                column_gene_name: '',
            };

            function filterRows() {
                var rows = document.querySelectorAll('#result-table tbody tr');

                rows.forEach(function (row) {
                var showRow = true;

                Object.keys(filterStates).forEach(function (column) {
                    var filterValue = filterStates[column];
                    var cell = row.querySelector('td[data-column="' + column + '"]');
                    var cellValue = cell.textContent;

                    if (!isNaN(parseFloat(cellValue))) {
                        var floatValue = parseFloat(cellValue);

                        if (floatValue <= parseFloat(filterValue)) {
                            showRow = false;
                        }
                    }

                    else if (filterValue !== '' && cellValue !== filterValue) {
                        showRow = false;
                    }
                });

                row.style.display = showRow ? '' : 'none';
            });
            }

            function setFilterState(column, filterValue) {
                filterStates[column] = filterValue;
                filterRows();
            }

            function resetFilters() {
                Object.keys(filterStates).forEach(function (column) {
                    filterStates[column] = '';
                });
                filterRows();
            }
        </script>

        <script>
            function filterColumn(column, filterValue) {
                setFilterState(column, filterValue);
            }
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var table = document.getElementById('result-table');
                var resetBtn = document.getElementById('reset-filters-btn');

                var filterDropdowns = Array.from(table.querySelectorAll('.filter-dropdown'));

                function resetFilters() {
                    filterDropdowns.forEach(function(dropdown) {
                        dropdown.value = 'All';
                    });
                }

                resetBtn.addEventListener('click', resetFilters);
            });
        </script>

        <script>
            function filterAbSpliceDNA(cutoff) {
                var rows = document.querySelectorAll('#result-table tbody tr');
                var filterValues = [];

                rows.forEach(function (row) {
                    var abspliceDNA = parseFloat(row.querySelector('td[data-column="column4"]').textContent);
                    var filterValue = 0;

                    if (cutoff === 'high' && abspliceDNA > 0.2) {
                        filterValue = 0.2;
                    } else if (cutoff === 'medium' && abspliceDNA > 0.05) {
                        filterValue = 0.05;
                    } else if (cutoff === 'low' && abspliceDNA > 0.01) {
                        filterValue = 0.01;
                    } else if (cutoff === 'all' && abspliceDNA > -1) {
                        filterValue = -1;
                    }

                    filterValues.push(filterValue);
                });

                var maxFilterValue = Math.max(...filterValues);
                filterStates['column4'] = maxFilterValue;
                filterRows();
            }
        </script>
        
        <script>
            function generateLink(variant, genome) {
                var parts = variant.split(':');
                var chr = parts[0];
                var pos = parts[1];
                var genome = genome;

                var url = "https://genome.ucsc.edu/cgi-bin/hgTracks?db=" + genome + '&position=' + chr + ":" + pos;
                window.open(url, "_blank");
            }
        </script>
    </div>
</body>
</html>